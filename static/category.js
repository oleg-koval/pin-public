// Generated by CoffeeScript 1.4.0

jQuery(function() {
  var clear_repin_form_notifications, disableMiddleMouseButtonScrolling, disableNormalScroll, disable_scroll, enable_scroll, get_more_items, open_pin_detail, show_error, simplify_url;
  $.ajaxSetup({
    cache: false
  });
  get_more_items = function(start) {
    var _this = this;
    if ($.loading_more) {
      return;
    }
    $.loading_more = true;
    $.getJSON('', {
      ajax: 1,
      'start': start
    }, function(data) {
      var html_text, pin, _i, _len;
      $('#big_loading_image').hide();
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        pin = data[_i];
        pin['simplifiedurl'] = simplify_url(pin['link']);
        if (pin['tags'] !== null) {
          pin['taglist'] = pin['tags'];
        }
        pin['image_loading'] = '';
        html_text = $.pin_template(pin);
        $('#category_column_' + $.column_control).append(html_text);
        if ($.column_control === 5) {
          $.column_control = 1;
        } else {
          $.column_control += 1;
        }
      }
      $.loading_more = false;
      $('#small_loading_image').show();
      window.setTimeout($('img.lazy').lazyload({
        failure_limit: 100
      }), 100);
    });
  };
  simplify_url = function(url) {
    var first_slash_position, simplified;
    simplified = url;
    if (simplified.indexOf('http:') === 0) {
      simplified = simplified.substring(6, simplified.length - 1);
    }
    if (simplified.indexOf('https:') === 0) {
      simplified = simplified.substring(7, simplified.length - 1);
    }
    if (simplified.indexOf('//') === 0) {
      simplified = simplified.substring(2, simplified.length - 1);
    }
    if (simplified.indexOf('/') === 0) {
      simplified = simplified.substring(1, simplified.length - 1);
    }
    first_slash_position = simplified.indexOf('/');
    if (first_slash_position > 0) {
      simplified = simplified.substring(0, first_slash_position);
    }
    return simplified;
  };
  $(window).scroll(function() {
    var doc_height, height, top;
    top = $(window).scrollTop();
    height = $(window).innerHeight();
    doc_height = $(document).height();
    if (top + height > doc_height) {
      get_more_items();
    }
  });
  $(document).on('mouseenter', '.category_pin', function(event) {
    var buttons;
    event.preventDefault();
    buttons = $(this).children('.category_pins_buttons');
    buttons.css($(this).offset());
    buttons.show();
  });
  $(document).on('mouseleave', '.category_pin', function(event) {
    var buttons;
    event.preventDefault();
    buttons = $(this).children('.category_pins_buttons');
    buttons.hide();
  });
  $(document).on('click', '.category_pin_image', function(event) {
    var pinid;
    event.preventDefault();
    pinid = $(this).attr('pinid');
    return open_pin_detail(pinid);
  });
  open_pin_detail = function(pinid) {
    $.get('/p/' + pinid + '?embed=true', function(data) {
      var current_position;
      try {
        if (window.history.state === null) {
          window.history.pushState(pinid, '', '/p/' + pinid);
        } else {
          window.history.replaceState(pinid, '', '/p/' + pinid);
        }
      } catch (error) {
        window.location.href = '/p/' + pinid;
        return;
      }
      $('#show_pin_layer_content').html(data);
      current_position = $('#show_pin_layer_content').position();
      current_position.top = $(window).scrollTop();
      $('#show_pin_layer_content').css(current_position);
      $('#show_pin_layer').width($(window).width());
      $('#show_pin_layer').height($(window).height());
      $('#show_pin_layer').show();
      disable_scroll();
    });
  };
  $('#show_pin_layer').on('click', function(event) {
    if (event.target.id === 'input-comment') {
      $('#input-comment').focus();
      return;
    }
    event.preventDefault();
    $(this).hide();
    enable_scroll();
    try {
      window.history.back();
    } catch (error) {
      $.noop();
    }
  });
  $('#show_pin_layer_content').on('click', function(event) {
    event.stopPropagation();
    try {
      event.stopInmediatePropagation();
    } catch (error) {
      $.noop();
    }
    if (event.target.id === 'input-comment') {
      $('#input-comment').focus();
    }
  });
  window.onpopstate = function(event) {
    var path, pinid;
    path = document.location.pathname;
    if (path.substring(0, 10) === '/category/') {
      $('#show_pin_layer').hide();
      enable_scroll();
    } else if (path.substring(0, 3) === '/p/') {
      pinid = path.substring(3, path.length);
      open_pin_detail(pinid);
    }
  };
  disable_scroll = function() {
    $(document).on('mousedown', disableMiddleMouseButtonScrolling);
    $(document).on('mousewheel DOMMouseScroll wheel', disableNormalScroll);
    $(window).on('scroll', disableNormalScroll);
    return $.oldScrollTop = $(document).scrollTop();
  };
  enable_scroll = function() {
    $(document).off('mousedown', disableMiddleMouseButtonScrolling);
    $(document).off('mousewheel DOMMouseScroll wheel', disableNormalScroll);
    return $(window).off('scroll', disableNormalScroll);
  };
  disableMiddleMouseButtonScrolling = function(e) {
    if (e.which === 2) {
      if (e.target.id !== 'show_pin_layer') {
        $('html, body').scrollTop($.oldScrollTop);
        return true;
      }
      e.preventDefault();
    }
    return false;
  };
  disableNormalScroll = function(e) {
    if (e.target.id !== 'show_pin_layer') {
      $('html, body').scrollTop($.oldScrollTop);
      return true;
    }
    e.preventDefault();
    $('html, body').scrollTop($.oldScrollTop);
    return false;
  };
  $.pin_template = _.template($('#pin_template').html());
  $.column_control = 1;
  $.loading_more = false;
  get_more_items(true);
  $('#repin-form').on('submit', function() {
    var form_has_errors;
    clear_repin_form_notifications();
    form_has_errors = false;
    if ($(this).find('#description').val() === '') {
      form_has_errors = true;
      show_error($(this).find('#description_error'), 'Please add a description');
    }
    if ($(this).find('#board_name').val() === '' && $(this).find('#board').val() === '') {
      form_has_errors = true;
      show_error($(this).find('#board_creation_layer'), 'Please select or add a list');
    }
    if (form_has_errors) {
      return false;
    }
    return true;
  });
  show_error = function(element, message) {
    return element.after('<span class="red">' + message + '</span>');
  };
  clear_repin_form_notifications = function() {
    return $('span.red').remove();
  };
});
